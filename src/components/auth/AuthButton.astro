---
import Github from "../../icons/Github.astro";
import FlechaAbajo from "../../icons/FlechaAbajo.astro";
import { getSession } from "auth-astro/server";

const session = await getSession(Astro.request);
---

{
    session ? (
        <>
            <div class="relative flex justify-center items-center gap-x-2">
                <button class="bg-black text-white rounded-2xl h-12 w-40 text-sm text-center flex justify-center items-center gap-x-1">
                    <img
                        src={session.user?.image}
                        alt="Github avatar"
                        class="w-9"
                    />{" "}
                    {session.user?.name}
                </button>

                <button id="toggleModal" class="flex items-center">
                    <FlechaAbajo />
                </button>

                <div
                    id="modal"
                    class="hidden absolute top-full mt-2 w-48 bg-white rounded-lg shadow-lg"
                >
                    <ul class="p-2 text-[#667085]">
                        <li>
                            <a
                                href="/auth/ViewProfile"
                                class="block px-4 py-2 hover:bg-gray-200"
                            >
                                View Profile
                            </a>
                        </li>
                        <li>
                            <a
                                href="/auth/MyProjects"
                                class="block px-4 py-2 hover:bg-gray-200"
                            >
                                My Projects
                            </a>
                        </li>

                        <div class="border-t" />
                        <li>
                            <a
                                id="logout"
                                class="block px-4 py-2 hover:bg-gray-200 cursor-pointer"
                            >
                                Log Out
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </>
    ) : (
        <>
            <button
                id="login"
                class="bg-black text-white rounded-2xl h-12 w-40 text-1xl text-center flex justify-center items-center gap-x-2"
            >
                <Github />
                Sign Up
            </button>
        </>
    )
}

<script>
    const { signIn, signOut } = await import("auth-astro/client");

    const loginButton = document.querySelector("#login");
    loginButton?.addEventListener("click", () => signIn("github"));

    const logoutButton = document.querySelector("#logout");
    logoutButton?.addEventListener("click", async () => {
        await signOut();
        window.location.href = "/";
    });

    const toggleModalButton = document.querySelector("#toggleModal");
    const modal = document.querySelector("#modal");

    toggleModalButton?.addEventListener("click", () => {
        if (modal) {
            modal.classList.toggle("hidden");
        }
    });

    // Optional: Hide the modal when clicking outside of it
    document.addEventListener("click", (event) => {
        const target = event.target as Node;
        if (!toggleModalButton?.contains(target) && !modal?.contains(target)) {
            modal?.classList.add("hidden");
        }
    });
</script>

<style>
    .hidden {
        display: none;
    }
</style>
